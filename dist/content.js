"use strict";(()=>{var xn=Object.defineProperty;var Sn=(e,t,n)=>t in e?xn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var i=(e,t,n)=>Sn(e,typeof t!="symbol"?t+"":t,n);function E(e){let t=[/v=([^&]+)/,/youtu\.be\/([^?&]+)/,/embed\/([^?&]+)/,/music\.youtube\.com\/watch\?v=([^&]+)/];for(let n of t){let r=e.match(n);if(r)return r[1]}return null}var _n="AIzaSyByzNFPU1XR0gm_kfd2EoThjYlVeezmup8";async function Q(e){let t=`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${e}&key=${_n}`,r=await(await fetch(t)).json();if(!r.items?.length)return null;let o=r.items[0].snippet;return console.log(o.channelId),{title:o.title,channel:o.channelTitle,description:o.description,tags:o.tags,id:o.channelId}}function qt(){let e,t;location.hostname==="music.youtube.com"?(e=document.querySelector(".title.ytmusic-player-bar"),t=document.querySelector(".byline.ytmusic-player-bar a")):(e=document.querySelector("h1.title yt-formatted-string")||document.querySelector("ytd-watch-metadata h1"),t=document.querySelector("#owner-name a")||document.querySelector("ytd-channel-name#channel-name a"));let n=document.querySelector("#description"),r=document.querySelector('a.yt-simple-endpoint.style-scope.yt-formatted-string[href^="/@"]');return console.log("[YT-EXT] titleEl",e,"channelEl",t),e&&console.log("Title: ",e.textContent.trim()),t&&console.log("Channel: ",t.textContent.trim()),t&&e&&n?(console.log(r?.textContent?.trim()),{videoTitle:e.textContent.trim(),channel:t.textContent.trim(),description:n?.textContent.trim(),username:r?.textContent.trim()}):(console.log("no info found"),null)}function $t(e,t="name"){return`${t}:${e.toLowerCase()}`}async function dt(e,t,n="name"){let r=$t(e,n),o={data:t,timestamp:Date.now(),links:t.links||[]};console.log(`cached artist: ${JSON.stringify(o)}`),await chrome.storage.local.set({[`cache_${r}`]:o})}async function ft(e,t="name"){let n=$t(e,t),o=(await chrome.storage.local.get(`cache_${n}`))[`cache_${n}`];return o?Date.now()-o.timestamp>18e4?(await chrome.storage.local.remove(`cache_${n}`),null):o.data:null}async function Et(e,t){let n=`video_${e}`;await chrome.storage.local.set({[`cache_${n}`]:{data:t,timestamp:Date.now()}})}async function Kt(e){let t=`video_${e}`,r=(await chrome.storage.local.get(`cache_${t}`))[`cache_${t}`];return r?Date.now()-r.timestamp>18e4?(await chrome.storage.local.remove(`cache_${t}`),null):r.data:null}function Ft(e){let t=(e.title||"").toLowerCase().trim();return`${(e.channel||"").toLowerCase().trim()}_${t}`.replace(/[^a-z0-9_]/g,"")}async function Lt(e){let t=Ft(e),r=(await chrome.storage.local.get(`cache_media_${t}`))[`cache_media_${t}`];return console.log(`grabbing cache with key: cache is  ${r}`),r?Date.now()-r.timestamp>18e4?(await chrome.storage.local.remove(`cache_media_${t}`),null):r.data:null}async function ht(e,t){let n=Ft(e);await chrome.storage.local.set({[`cache_media_${n}`]:{data:t,timestamp:Date.now(),originalMediaData:e}}),console.log(`caching data: ${n}`)}var K="https://mn-chrome-ext.vercel.app";async function jt(e){console.log("fetchArtist called with:",e);let t=await ft(e.id,"id");if(t)return console.log("[DEBUG: returning cached "+JSON.stringify(t)+"]"),t;let n=`${K}/api/artist/by-id/${encodeURIComponent(e.id)}`;console.log("Fetching artist from:",n);let r=await fetch(n),o=r.ok?await r.json():null;if(console.log("Artist API response:",o),o&&o.id){let a=`${K}/api/urlmap/links/${encodeURIComponent(o.id)}`,p=await fetch(a);o.links=p.ok?await p.json():[];try{let m=`https://api.musicnerd.xyz/api/getSpotifyData?spotifyId=${o.spotify}`,u=await fetch(m);u.ok&&(o.spotifyData=await u.json())}catch{o.spotifyData=null}dt(e.id,o,"id")}return o}async function Vt(e){let t=await ft(e.channel);if(t)return t;console.log("fetchArtistFromName called with:",e);let n="https://api.musicnerd.xyz/api/searchArtists/batch";console.log("Fetching artist from (batch-single):",e.channel);let r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:{artists:[e.channel]}})}),o=r.ok?await r.json():{artists:[null]},a=Array.isArray(o.results)?o.results[0]:null;if(console.log("Artist API response:",a),a.matchScore!=0)return null;if(a&&!a.error&&a.id){let p=`${K}/api/urlmap/links/${encodeURIComponent(a.id)}`,m=await fetch(p);a.links=m.ok?await m.json():[];try{let u=await fetch(`https://api.musicnerd.xyz/api/artistBio/${encodeURIComponent(a.id)}`,{headers:{Accept:"application/json"}});if(u.ok){let s=await u.json();a.bio=typeof s=="string"?s:s?.bio??s?.text??null}else a.bio=null}catch{a.bio=null}try{let u=`https://api.musicnerd.xyz/api/getSpotifyData?spotifyId=${a.spotify}`,s=await fetch(u);s.ok&&(a.spotifyData=await s.json())}catch{a.spotifyData=null}dt(e.channel,a)}return a}async function F(e){let t=`${K}/api/openai/extract-multiple-artists`,r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(typeof e=="string"?{title:e}:{data:e})});return r.ok?(await r.json()).artists||[]:[]}async function L(e){if(!e||e.length===0)return[];console.log("fetchMultipleArtistsByNames called with:",e);let n=await fetch("https://api.musicnerd.xyz/api/searchArtists/batch",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:{artists:e}})});if(!n.ok)return console.error("Batch artist fetch failed:",n.status,n.statusText),[];let r=await n.json(),o=Array.isArray(r.results)?r.results:[];console.log("Batch artist API response:",r);let a=o.filter(m=>m&&m.id&&m.matchScore==0);return await Promise.all(a.map(async m=>{if(!m||!m.id)return m;let u=`${K}/api/urlmap/links/${encodeURIComponent(m.id)}`,s=`https://api.musicnerd.xyz/api/artistBio/${encodeURIComponent(m.id)}`,d=`https://api.musicnerd.xyz/api/getSpotifyData?spotifyId=${m.spotify}`,[f,z,Pt]=await Promise.all([fetch(u),fetch(s,{method:"GET",headers:{Accept:"application/json"}}),fetch(d,{method:"GET",headers:{Accept:"application/json"}})]),gn=f.ok?await f.json():[],wn=z.ok?await z.json():null,bn=Pt.ok?await Pt.json():null;return{...m,links:gn,bio:wn,spotifyData:bn}}))}function yt(e){return[/\bft\.?\s/i,/\bfeat\.?\s/i,/\bfeaturing\b/i,/\bwith\b/i,/\sx\s/i,/\s&\s/,/\s\+\s/,/\bvs\.?\b/i,/\b(collab|collaboration)\b/i,/\bremix by\b/i,/\bprod\.? by\b/i].some(n=>n.test(e))}async function Tn(){console.log("preloading...");try{let e=v();if(!e||!e.title){console.log("No media session data to preload");return}let t=await Lt(e);if(t){console.log("Preload: cached result already exists: "+t);return}let n=[];if(e.title){let r=await Vt(e);if(r&&!r.error&&r.id){if(n.push({...r,isPrimary:!0}),yt(e.title)){let a=(await F(e)).filter(p=>p.toLowerCase()!==r.name.toLowerCase());if(a.length>0){let m=(await L(a)).filter(u=>u&&!u.error&&u.id).map(u=>({...u,isPrimary:!1}));n.push(...m)}}if(n.length>0)return await ht(e,n),console.log("Successfully preloaded and cached artist data via name lookup"),n}}if(e.title&&n.length===0){console.log("Preload: falling back to AI extraction");let r=await F(e);if(console.log("AI extracted names:",r),r.length>0){let a=(await L(r)).filter(p=>p&&!p.error&&p.id).map(p=>({...p,isPrimary:!1}));n.push(...a)}await ht(e,n)}return n}catch(e){return console.error("Preload error:",e),[]}}async function Nn(){let e=E(window.location.href);if(!e||await Kt(e))return;let n=await Q(e);if(!n)return;let r=[],o=await jt({id:n.id,title:n.title,channel:n.channel});if(o&&!o.error&&(r.push({...o,isPrimary:!0}),yt(n.title))){console.log("[preload] using AI for collaborators");let p=(await F(n)).filter(m=>m.toLowerCase()!==o.name.toLowerCase());if(p.length>0){let u=(await L(p)).filter(s=>s&&!s.error&&s.id).map(s=>({...s,isPrimary:!1}));r.push(...u)}}if(r.length===0&&n.title){console.log("[Preload] falling back to AI");let a=await F(n);if(a.length>0){let m=(await L(a)).filter(u=>u&&!u.error&&u.id).map(u=>({...u,isPrimary:!1}));r.push(...m)}}return r.length>0&&console.log("Successfully preloaded YouTube data"),await Et(e,r),r}async function Ut(){try{let e=E(window.location.href);if(e)return console.log("preloading youtube"),await Nn(e);let t=v();return t&&t.title?(console.log("preloading media session"),await Tn(t)):(console.log("No preloadable content found"),[])}catch(e){return console.error("Preload error:",e),[]}}var c=Symbol.for("drizzle:entityKind"),Wn=Symbol.for("drizzle:hasOwnEntityKind");function b(e,t){if(!e||typeof e!="object")return!1;if(e instanceof t)return!0;if(!Object.prototype.hasOwnProperty.call(t,c))throw new Error(`Class "${t.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let n=e.constructor;if(n)for(;n;){if(c in n&&n[c]===t[c])return!0;n=Object.getPrototypeOf(n)}return!1}var kt;kt=c;var T=class{constructor(t,n){i(this,"name");i(this,"primary");i(this,"notNull");i(this,"default");i(this,"defaultFn");i(this,"onUpdateFn");i(this,"hasDefault");i(this,"isUnique");i(this,"uniqueName");i(this,"uniqueType");i(this,"dataType");i(this,"columnType");i(this,"enumValues");i(this,"config");this.table=t,this.config=n,this.name=n.name,this.notNull=n.notNull,this.default=n.default,this.defaultFn=n.defaultFn,this.onUpdateFn=n.onUpdateFn,this.hasDefault=n.hasDefault,this.primary=n.primaryKey,this.isUnique=n.isUnique,this.uniqueName=n.uniqueName,this.uniqueType=n.uniqueType,this.dataType=n.dataType,this.columnType=n.columnType}mapFromDriverValue(t){return t}mapToDriverValue(t){return t}};i(T,kt,"Column");var Ot;Ot=c;var j=class{constructor(t,n,r){i(this,"config");i(this,"$default",this.$defaultFn);i(this,"$onUpdate",this.$onUpdateFn);this.config={name:t,notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:n,columnType:r}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(t){return this.config.default=t,this.config.hasDefault=!0,this}$defaultFn(t){return this.config.defaultFn=t,this.config.hasDefault=!0,this}$onUpdateFn(t){return this.config.onUpdateFn=t,this.config.hasDefault=!0,this}primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}};i(j,Ot,"ColumnBuilder");var gt=Symbol.for("drizzle:Name"),wt=Symbol.for("drizzle:Schema"),Mt=Symbol.for("drizzle:Columns"),bt=Symbol.for("drizzle:OriginalName"),xt=Symbol.for("drizzle:BaseName"),Qt=Symbol.for("drizzle:IsAlias"),Rt=Symbol.for("drizzle:ExtraConfigBuilder"),An=Symbol.for("drizzle:IsDrizzleTable"),Bt,Yt,Jt,Wt,Gt,Xt,Zt,Ht,te;te=c,Ht=gt,Zt=bt,Xt=wt,Gt=Mt,Wt=xt,Jt=Qt,Yt=Rt,Bt=An;var w=class{constructor(t,n,r){i(this,Ht);i(this,Zt);i(this,Xt);i(this,Gt);i(this,Wt);i(this,Jt,!1);i(this,Yt);i(this,Bt,!0);this[gt]=this[bt]=t,this[wt]=n,this[xt]=r}};i(w,te,"Table"),i(w,"Symbol",{Name:gt,Schema:wt,OriginalName:bt,Columns:Mt,BaseName:xt,IsAlias:Qt,ExtraConfigBuilder:Rt});var St=Symbol.for("drizzle:PgInlineForeignKeys"),ee,ne,re,ie,_=class extends(ie=w,re=c,ne=St,ee=w.Symbol.ExtraConfigBuilder,ie){constructor(){super(...arguments);i(this,ne,[]);i(this,ee)}};i(_,re,"PgTable"),i(_,"Symbol",Object.assign({},w.Symbol,{InlineForeignKeys:St}));function Cn(e,t,n,r,o=e){let a=new _(e,r,o),p=Object.fromEntries(Object.entries(t).map(([u,s])=>{let d=s,f=d.build(a);return a[St].push(...d.buildForeignKeys(f,a)),[u,f]})),m=Object.assign(a,p);return m[w.Symbol.Columns]=p,n&&(m[_.Symbol.ExtraConfigBuilder]=n),m}var V=(e,t,n)=>Cn(e,t,n,void 0);var oe;oe=c;var I=class{constructor(t,n){i(this,"reference");i(this,"_onUpdate","no action");i(this,"_onDelete","no action");this.reference=()=>{let{name:r,columns:o,foreignColumns:a}=t();return{name:r,columns:o,foreignTable:a[0].table,foreignColumns:a}},n&&(this._onUpdate=n.onUpdate,this._onDelete=n.onDelete)}onUpdate(t){return this._onUpdate=t===void 0?"no action":t,this}onDelete(t){return this._onDelete=t===void 0?"no action":t,this}build(t){return new R(t,this)}};i(I,oe,"PgForeignKeyBuilder");var se;se=c;var R=class{constructor(t,n){i(this,"reference");i(this,"onUpdate");i(this,"onDelete");this.table=t,this.reference=n.reference,this.onUpdate=n._onUpdate,this.onDelete=n._onDelete}getName(){let{name:t,columns:n,foreignColumns:r}=this.reference(),o=n.map(m=>m.name),a=r.map(m=>m.name),p=[this.table[_.Symbol.Name],...o,r[0].table[_.Symbol.Name],...a];return t??`${p.join("_")}_fk`}};i(R,se,"PgForeignKey");function ae(e){function t(){let{name:n,columns:r,foreignColumns:o}=e;return{name:n,columns:r,foreignColumns:o}}return new I(t)}function B(e,...t){return e(...t)}function U(e){return new J(e)}function _t(e,t){return`${e[_.Symbol.Name]}_${t.join("_")}_unique`}var le;le=c;var Y=class{constructor(t,n){i(this,"columns");i(this,"nullsNotDistinctConfig",!1);this.name=n,this.columns=t}nullsNotDistinct(){return this.nullsNotDistinctConfig=!0,this}build(t){return new W(t,this.columns,this.nullsNotDistinctConfig,this.name)}};i(Y,le,"PgUniqueConstraintBuilder");var ce;ce=c;var J=class{constructor(t){i(this,"name");this.name=t}on(...t){return new Y(t,this.name)}};i(J,ce,"PgUniqueOnConstraintBuilder");var ue;ue=c;var W=class{constructor(t,n,r,o){i(this,"columns");i(this,"name");i(this,"nullsNotDistinct",!1);this.table=t,this.columns=n,this.name=o??_t(this.table,this.columns.map(a=>a.name)),this.nullsNotDistinct=r}getName(){return this.name}};i(W,ue,"PgUniqueConstraint");function me(e,t,n){for(let r=t;r<e.length;r++){let o=e[r];if(o==="\\"){r++;continue}if(o==='"')return[e.slice(t,r).replace(/\\/g,""),r+1];if(!n&&(o===","||o==="}"))return[e.slice(t,r).replace(/\\/g,""),r]}return[e.slice(t).replace(/\\/g,""),e.length]}function pe(e,t=0){let n=[],r=t,o=!1;for(;r<e.length;){let a=e[r];if(a===","){(o||r===t)&&n.push(""),o=!0,r++;continue}if(o=!1,a==="\\"){r+=2;continue}if(a==='"'){let[u,s]=me(e,r+1,!0);n.push(u),r=s;continue}if(a==="}")return[n,r+1];if(a==="{"){let[u,s]=pe(e,r+1);n.push(u),r=s;continue}let[p,m]=me(e,r,!1);n.push(p),r=m}return[n,r]}function de(e){let[t]=pe(e,1);return t}function Tt(e){return`{${e.map(t=>Array.isArray(t)?Tt(t):typeof t=="string"?`"${t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`:`${t}`).join(",")}}`}var fe,he,g=class extends(he=j,fe=c,he){constructor(){super(...arguments);i(this,"foreignKeyConfigs",[])}array(n){return new G(this.config.name,this,n)}references(n,r={}){return this.foreignKeyConfigs.push({ref:n,actions:r}),this}unique(n,r){return this.config.isUnique=!0,this.config.uniqueName=n,this.config.uniqueType=r?.nulls,this}buildForeignKeys(n,r){return this.foreignKeyConfigs.map(({ref:o,actions:a})=>B((p,m)=>{let u=new I(()=>{let s=p();return{columns:[n],foreignColumns:[s]}});return m.onUpdate&&u.onUpdate(m.onUpdate),m.onDelete&&u.onDelete(m.onDelete),u.build(r)},o,a))}};i(g,fe,"PgColumnBuilder");var ye,ge,h=class extends(ge=T,ye=c,ge){constructor(t,n){n.uniqueName||(n.uniqueName=_t(t,[n.name])),super(t,n),this.table=t}};i(h,ye,"PgColumn");var we,be,G=class extends(be=g,we=c,be){constructor(t,n,r){super(t,"array","PgArray"),this.config.baseBuilder=n,this.config.size=r}build(t){let n=this.config.baseBuilder.build(t);return new Nt(t,this.config,n)}};i(G,we,"PgArrayBuilder");var xe,Se,X=class X extends(Se=h,xe=c,Se){constructor(n,r,o,a){super(n,r);i(this,"size");this.baseColumn=o,this.range=a,this.size=r.size}getSQLType(){return`${this.baseColumn.getSQLType()}[${typeof this.size=="number"?this.size:""}]`}mapFromDriverValue(n){return typeof n=="string"&&(n=de(n)),n.map(r=>this.baseColumn.mapFromDriverValue(r))}mapToDriverValue(n,r=!1){let o=n.map(a=>a===null?null:b(this.baseColumn,X)?this.baseColumn.mapToDriverValue(a,!0):this.baseColumn.mapToDriverValue(a));return r?o:Tt(o)}};i(X,xe,"PgArray");var Nt=X;var At=Symbol.for("drizzle:isPgEnum");function Ce(e){return!!e&&typeof e=="function"&&At in e&&e[At]===!0}var _e,Te,Z=class extends(Te=g,_e=c,Te){constructor(t,n){super(t,"string","PgEnumColumn"),this.config.enum=n}build(t){return new H(t,this.config)}};i(Z,_e,"PgEnumColumnBuilder");var Ne,Ae,H=class extends(Ae=h,Ne=c,Ae){constructor(n,r){super(n,r);i(this,"enum",this.config.enum);i(this,"enumValues",this.config.enum.enumValues);this.enum=r.enum}getSQLType(){return this.enum.enumName}};i(H,Ne,"PgEnumColumn");function ze(e,t){return zn(e,t,void 0)}function zn(e,t,n){let r=Object.assign(o=>new Z(o,r),{enumName:e,enumValues:t,schema:n,[At]:!0});return r}var ve;ve=c;var A=class{constructor(t,n,r,o=!1){this._={brand:"Subquery",sql:t,selectedFields:n,alias:r,isWith:o}}};i(A,ve,"Subquery");var Ie,De,Ct=class extends(De=A,Ie=c,De){};i(Ct,Ie,"WithSubquery");var Pe="0.30.10";var zt,vt,qe={startActiveSpan(e,t){return zt?(vt||(vt=zt.trace.getTracer("drizzle-orm",Pe)),B((n,r)=>r.startActiveSpan(e,o=>{try{return t(o)}catch(a){throw o.setStatus({code:n.SpanStatusCode.ERROR,message:a instanceof Error?a.message:"Unknown error"}),a}finally{o.end()}}),zt,vt)):t()}};var k=Symbol.for("drizzle:ViewBaseConfig");var $e;$e=c;var It=class{};i(It,$e,"FakePrimitiveParam");function vn(e){return e!=null&&typeof e.getSQL=="function"}function In(e){let t={sql:"",params:[]};for(let n of e)t.sql+=n.sql,t.params.push(...n.params),n.typings?.length&&(t.typings||(t.typings=[]),t.typings.push(...n.typings));return t}var Ee;Ee=c;var x=class{constructor(t){i(this,"value");this.value=Array.isArray(t)?t:[t]}getSQL(){return new y([this])}};i(x,Ee,"StringChunk");var Ke;Ke=c;var C=class C{constructor(t){i(this,"decoder",ke);i(this,"shouldInlineParams",!1);this.queryChunks=t}append(t){return this.queryChunks.push(...t.queryChunks),this}toQuery(t){return qe.startActiveSpan("drizzle.buildSQL",n=>{let r=this.buildQueryFromSourceParams(this.queryChunks,t);return n?.setAttributes({"drizzle.query.text":r.sql,"drizzle.query.params":JSON.stringify(r.params)}),r})}buildQueryFromSourceParams(t,n){let r=Object.assign({},n,{inlineParams:n.inlineParams||this.shouldInlineParams,paramStartIndex:n.paramStartIndex||{value:0}}),{escapeName:o,escapeParam:a,prepareTyping:p,inlineParams:m,paramStartIndex:u}=r;return In(t.map(s=>{if(b(s,x))return{sql:s.value.join(""),params:[]};if(b(s,D))return{sql:o(s.value),params:[]};if(s===void 0)return{sql:"",params:[]};if(Array.isArray(s)){let d=[new x("(")];for(let[f,z]of s.entries())d.push(z),f<s.length-1&&d.push(new x(", "));return d.push(new x(")")),this.buildQueryFromSourceParams(d,r)}if(b(s,C))return this.buildQueryFromSourceParams(s.queryChunks,{...r,inlineParams:m||s.shouldInlineParams});if(b(s,w)){let d=s[w.Symbol.Schema],f=s[w.Symbol.Name];return{sql:d===void 0?o(f):o(d)+"."+o(f),params:[]}}if(b(s,T))return{sql:o(s.table[w.Symbol.Name])+"."+o(s.name),params:[]};if(b(s,tt)){let d=s[k].schema,f=s[k].name;return{sql:d===void 0?o(f):o(d)+"."+o(f),params:[]}}if(b(s,O)){let d=s.value===null?null:s.encoder.mapToDriverValue(s.value);if(b(d,C))return this.buildQueryFromSourceParams([d],r);if(m)return{sql:this.mapInlineParam(d,r),params:[]};let f;return p!==void 0&&(f=[p(s.encoder)]),{sql:a(u.value++,d),params:[d],typings:f}}return b(s,M)?{sql:a(u.value++,s),params:[s]}:b(s,C.Aliased)&&s.fieldAlias!==void 0?{sql:o(s.fieldAlias),params:[]}:b(s,A)?s._.isWith?{sql:o(s._.alias),params:[]}:this.buildQueryFromSourceParams([new x("("),s._.sql,new x(") "),new D(s._.alias)],r):Ce(s)?s.schema?{sql:o(s.schema)+"."+o(s.enumName),params:[]}:{sql:o(s.enumName),params:[]}:vn(s)?this.buildQueryFromSourceParams([new x("("),s.getSQL(),new x(")")],r):m?{sql:this.mapInlineParam(s,r),params:[]}:{sql:a(u.value++,s),params:[s]}}))}mapInlineParam(t,{escapeString:n}){if(t===null)return"null";if(typeof t=="number"||typeof t=="boolean")return t.toString();if(typeof t=="string")return n(t);if(typeof t=="object"){let r=t.toString();return n(r==="[object Object]"?JSON.stringify(t):r)}throw new Error("Unexpected param value: "+t)}getSQL(){return this}as(t){return t===void 0?this:new C.Aliased(this,t)}mapWith(t){return this.decoder=typeof t=="function"?{mapFromDriverValue:t}:t,this}inlineParams(){return this.shouldInlineParams=!0,this}if(t){return t?this:void 0}};i(C,Ke,"SQL");var y=C,Fe;Fe=c;var D=class{constructor(t){i(this,"brand");this.value=t}getSQL(){return new y([this])}};i(D,Fe,"Name");var ke={mapFromDriverValue:e=>e},Oe={mapToDriverValue:e=>e},Jr={...ke,...Oe},Le;Le=c;var O=class{constructor(t,n=Oe){i(this,"brand");this.value=t,this.encoder=n}getSQL(){return new y([this])}};i(O,Le,"Param");function S(e,...t){let n=[];(t.length>0||e.length>0&&e[0]!=="")&&n.push(new x(e[0]));for(let[r,o]of t.entries())n.push(o,new x(e[r+1]));return new y(n)}(e=>{function t(){return new y([])}e.empty=t;function n(u){return new y(u)}e.fromList=n;function r(u){return new y([new x(u)])}e.raw=r;function o(u,s){let d=[];for(let[f,z]of u.entries())f>0&&s!==void 0&&d.push(s),d.push(z);return new y(d)}e.join=o;function a(u){return new D(u)}e.identifier=a;function p(u){return new M(u)}e.placeholder=p;function m(u,s){return new O(u,s)}e.param=m})(S||(S={}));(e=>{var n;n=c;let r=class r{constructor(a,p){i(this,"isSelectionField",!1);this.sql=a,this.fieldAlias=p}getSQL(){return this.sql}clone(){return new r(this.sql,this.fieldAlias)}};i(r,n,"SQL.Aliased");let t=r;e.Aliased=t})(y||(y={}));var je;je=c;var M=class{constructor(t){this.name=t}getSQL(){return new y([this])}};i(M,je,"Placeholder");var Ve,Ue;Ue=c,Ve=k;var tt=class{constructor({name:t,schema:n,selectedFields:r,query:o}){i(this,Ve);this[k]={name:t,originalName:t,schema:n,selectedFields:r,query:o,isExisting:!o,isAlias:!1}}getSQL(){return new y([this])}};i(tt,Ue,"View");T.prototype.getSQL=function(){return new y([this])};w.prototype.getSQL=function(){return new y([this])};A.prototype.getSQL=function(){return new y([this])};var Me,Qe,et=class extends(Qe=g,Me=c,Qe){constructor(t){super(t,"boolean","PgBoolean")}build(t){return new nt(t,this.config)}};i(et,Me,"PgBooleanBuilder");var Re,Be,nt=class extends(Be=h,Re=c,Be){getSQLType(){return"boolean"}};i(nt,Re,"PgBoolean");function N(e){return new et(e)}var Ye,Je,P=class extends(Je=g,Ye=c,Je){defaultNow(){return this.default(S`now()`)}};i(P,Ye,"PgDateColumnBaseBuilder");var We,Ge,rt=class extends(Ge=g,We=c,Ge){constructor(t){super(t,"number","PgInteger")}build(t){return new it(t,this.config)}};i(rt,We,"PgIntegerBuilder");var Xe,Ze,it=class extends(Ze=h,Xe=c,Ze){getSQLType(){return"integer"}mapFromDriverValue(t){return typeof t=="string"?Number.parseInt(t):t}};i(it,Xe,"PgInteger");function Dt(e){return new rt(e)}var He,tn,ot=class extends(tn=g,He=c,tn){constructor(t,n){super(t,"string","PgText"),this.config.enumValues=n.enum}build(t){return new st(t,this.config)}};i(ot,He,"PgTextBuilder");var en,nn,st=class extends(nn=h,en=c,nn){constructor(){super(...arguments);i(this,"enumValues",this.config.enumValues)}getSQLType(){return"text"}};i(st,en,"PgText");function l(e,t={}){return new ot(e,t)}var rn,on,at=class extends(on=P,rn=c,on){constructor(t,n,r){super(t,"date","PgTimestamp"),this.config.withTimezone=n,this.config.precision=r}build(t){return new lt(t,this.config)}};i(at,rn,"PgTimestampBuilder");var sn,an,lt=class extends(an=h,sn=c,an){constructor(n,r){super(n,r);i(this,"withTimezone");i(this,"precision");i(this,"mapFromDriverValue",n=>new Date(this.withTimezone?n:n+"+0000"));i(this,"mapToDriverValue",n=>n.toISOString());this.withTimezone=r.withTimezone,this.precision=r.precision}getSQLType(){return`timestamp${this.precision===void 0?"":` (${this.precision})`}${this.withTimezone?" with time zone":""}`}};i(lt,sn,"PgTimestamp");var ln,cn,ct=class extends(cn=P,ln=c,cn){constructor(t,n,r){super(t,"string","PgTimestampString"),this.config.withTimezone=n,this.config.precision=r}build(t){return new ut(t,this.config)}};i(ct,ln,"PgTimestampStringBuilder");var un,mn,ut=class extends(mn=h,un=c,mn){constructor(n,r){super(n,r);i(this,"withTimezone");i(this,"precision");this.withTimezone=r.withTimezone,this.precision=r.precision}getSQLType(){return`timestamp${this.precision===void 0?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}};i(ut,un,"PgTimestampString");function q(e,t={}){return t.mode==="string"?new ct(e,t.withTimezone??!1,t.precision):new at(e,t.withTimezone??!1,t.precision)}var pn,dn,mt=class extends(dn=g,pn=c,dn){constructor(t){super(t,"string","PgUUID")}defaultRandom(){return this.default(S`gen_random_uuid()`)}build(t){return new pt(t,this.config)}};i(mt,pn,"PgUUIDBuilder");var fn,hn,pt=class extends(hn=h,fn=c,hn){getSQLType(){return"uuid"}};i(pt,fn,"PgUUID");function $(e){return new mt(e)}var Dn=ze("platform_type",["social","web3","listen"]),Pn=V("users",{id:$("id").default(S`uuid_generate_v4()`).primaryKey().notNull()}),qi=V("artists",{id:$("id").default(S`uuid_generate_v4()`).primaryKey().notNull(),legacyId:l("legacy_id"),bandcamp:l("bandcamp"),facebook:l("facebook"),x:l("x"),soundcloud:l("soundcloud"),notes:l("notes"),patreon:l("patreon"),name:l("name"),instagram:l("instagram"),youtube:l("youtube"),youtubechannel:l("youtubechannel"),bio:l("bio"),lcname:l("lcname"),soundcloudId:Dt("soundcloudID"),spotify:l("spotify"),twitch:l("twitch"),imdb:l("imdb"),musicbrainz:l("musicbrainz"),wikidata:l("wikidata"),mixcloud:l("mixcloud"),facebookId:l("facebookID"),discogs:l("discogs"),tiktok:l("tiktok"),tiktokId:l("tiktokID"),jaxsta:l("jaxsta"),famousbirthdays:l("famousbirthdays"),songexploder:l("songexploder"),colorsxstudios:l("colorsxstudios"),bandsintown:l("bandsintown"),linktree:l("linktree"),onlyfans:l("onlyfans"),wikipedia:l("wikipedia"),audius:l("audius"),zora:l("zora"),catalog:l("catalog"),opensea:l("opensea"),foundation:l("foundation"),lastfm:l("lastfm"),linkedin:l("linkedin"),soundxyz:l("soundxyz"),mirror:l("mirror"),glassnode:l("glassnode"),collectsNfTs:N("collectsNFTs"),spotifyusername:l("spotifyusername"),bandcampfan:l("bandcampfan"),tellie:l("tellie"),wallets:l("wallets").array(),ens:l("ens"),lens:l("lens"),addedBy:$("added_by").notNull().default(S`uuid_generate_v4()`),cameo:l("cameo"),farcaster:l("farcaster"),supercollector:l("supercollector"),createdAt:q("created_at",{withTimezone:!0,mode:"string"}).defaultNow(),updatedAt:q("updated_at",{withTimezone:!0,mode:"string"}).default(S`(now() AT TIME ZONE 'utc'::text)`).notNull()},e=>({artistsAddedbyFkey:ae({columns:[e.addedBy],foreignColumns:[Pn.id],name:"artists_addedby_fkey"})})),$i=V("aiprompts",{id:$("prompt_id").primaryKey().defaultRandom(),promptName:l("prompt_name").default("unnamed_prompt"),promptBeforeName:l("prompt_before_name").notNull(),promptAfterName:l("prompt_after_name").notNull(),isDefault:N("is_default").default(!1),isEnabled:N("is_enabled").default(!1),createdAt:q("created_at").defaultNow()}),Ei=V("urlmap",{id:$("id").default(S`uuid_generate_v4()`).primaryKey().notNull(),siteUrl:l("site_url").notNull(),siteName:l("site_name").notNull(),example:l("example").notNull(),appStringFormat:l("app_string_format").notNull(),order:Dt("order"),isIframeEnabled:N("is_iframe_enabled").default(!1).notNull(),isEmbedEnabled:N("is_embed_enabled").default(!1).notNull(),cardDescription:l("card_description"),cardPlatformName:l("card_platform_name"),isWeb3Site:N("is_web3_site").notNull(),createdAt:q("created_at",{withTimezone:!0,mode:"string"}).default(S`(now() AT TIME ZONE 'utc'::text)`).notNull(),updatedAt:q("updated_at",{withTimezone:!0,mode:"string"}).default(S`(now() AT TIME ZONE 'utc'::text)`),siteImage:l("site_image"),regex:l("regex").default('""').notNull(),regexMatcher:l("regex_matcher"),isMonetized:N("is_monetized").default(!1).notNull(),regexOptions:l("regex_options").array(),platformTypeList:Dn("platform_type_list").array().default(["social"]),colorHex:l("color_hex").notNull()},e=>({urlmapSiteurlKey:U("urlmap_siteurl_key").on(e.siteUrl),urlmapSitenameKey:U("urlmap_sitename_key").on(e.siteName),urlmapExampleKey:U("urlmap_example_key").on(e.example),urlmapAppstingformatKey:U("urlmap_appstingformat_key").on(e.appStringFormat)}));function qn(){try{return chrome.runtime.id,!0}catch{return!1}}function v(){if(!("mediaSession"in navigator))return console.log("Media Session API not supported"),null;let e=navigator.mediaSession.metadata,t=navigator.mediaSession.playbackState;return t==="paused"?null:e?{title:e.title||"",channel:e.artist||"",album:e.album||"",source:"mediaSession",playbackState:t,url:window.location.href,domain:window.location.hostname}:(console.log("No useful media session data (no title or artist)"),null)}async function yn(){if(window.__mn_watch_started||(window.__mn_watch_started=!0,!("mediaSession"in navigator)))return;let e=null,t=null;setInterval(()=>{if(qn()){let r=navigator.mediaSession.metadata,o=navigator.mediaSession.playbackState,a=JSON.stringify({title:r?.title||"",artist:r?.artist||"",album:r?.album||""});if(a!==t&&o==="playing"){e=JSON.stringify(r),t=a;let m=Date.now();if(window.__mn_last_preload_ts&&m-window.__mn_last_preload_ts<4e3)return;window.__mn_last_preload_ts=m,chrome.runtime.sendMessage({action:"musicDetected",data:v()}),Ut()}else e=JSON.stringify(r),t=a}},3e3)}console.log("[YT-EXT] content script injected");yn();chrome.runtime.onMessage.addListener((e,t,n)=>{if(e.type==="GET_YT_INFO"){let r=E(location.href);if(!r)return n(null),!0;Q(r).then(o=>n(o)).catch(o=>{console.error("[YT-EXT] Fetch error",o),n(null)})}return e.type==="SCRAPE_YT_INFO"&&n(qt()),!0});chrome.runtime.onMessage.addListener((e,t,n)=>{e.action==="checkMediaSession"&&n(v())});})();
